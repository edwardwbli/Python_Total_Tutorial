
# 跨版本兼容

大家都知道Python因为版本间的兼容问题被不少人诟病,2.7版本第三方包兼容性最好,环境稳定,执行效率更高些,而3.X则有一些更方便的特性和人性化的地方.在快速入门时就讨论过版本选择问题,老实说这个真的很难取舍.用的人纠结其实些程序的人也纠结,有没有办法让我们的代码可以跨版兼容呢?大体上还是有的

## 如何判断Python版本

一般使用sys模块查看系统信息,python版本信息也同样在其中


```python
import sys
```


```python
sys.version_info
```




    sys.version_info(major=2, minor=7, micro=10, releaselevel='final', serial=0)




```python
sys.version_info <(3,0)
```




    True



用这种方式就可以根据不同的系统匹配不同的代码了

## range和xrange

在python2.7中有range和xrange两种等差数列生成器,第一种是返回一个列表,而第二种返回一个生成器,在python3中xrange被用来替代range了,因此xrange这个关键字被取消了,

如果是为了向下兼容,我们可以在python3的代码中前面加一句


```python
xrange=range
```


```python
xrange(10)==range(10)
```




    True



而在2.7中为了向上兼容,我们可以这样写


```python
import sys
if sys.version_info <(3,0):
    range = xrange
    xrange=None
```


```python
range(10)
```




    xrange(10)




```python
xrange(10)
```


    ---------------------------------------------------------------------------

    TypeError                                 Traceback (most recent call last)

    <ipython-input-6-57a23109d110> in <module>()
    ----> 1 xrange(10)
    

    TypeError: 'NoneType' object is not callable


## Python2.7的`__future__`模块

在python2.7中有个模块专门用来为3.X版本做承接之用,即`__future__`模块.它提供了:

+ print函数
+ 整数除法
+ Unicode
+ 相对引用特性

这4个主要的改变支持

### print函数

在python2.7中print 是语句,而python3中它成了函数.函数的好处是可以在lambda表达式中使用.
如果要用print函数,那可以这样:


```python
from __future__ import print_function
print(123)
```

    123


### 整数除法
在python2.7中整数除法只能得到整数,而python3中可以根据结果判断整数或者小数.要使用这一特性可以这样:


```python
from __future__ import division
print(3/2)
```

    1.5


### Unicode

在python2.7中默认的字符串类型是str,所以很多时候中文需要转码才不是乱码,而在python3中全局unicode.
想要使用这个特性可以这样:


```python
l = "asdff"
```


```python
type(l)
```




    str




```python
type(l.decode())
```




    unicode




```python
from __future__ import unicode_literals
```


```python
ll="asdff"
```


```python
type(ll)
```




    unicode




```python
type(ll.encode())
```




    str



注意,虽然字符串直接使用unicode,但依然不是全局的,也就是说变量名不能用中文

### 相对引用特性

所谓相对引用就是如:

    from . import b

在python2.7中想这样引用,需要:

    from __future__ import absolute_import



# 关于标准库和一些新特性

尽量使用2中有的标准库和特性,具体可以看标准库和进阶部分,import的时候如果有不同用这样的形式:

    try:#python2
        from UserDict import UserDict
        #建议按照python3的名字进行import
        from UserDict import DictMixin as MutableMapping
    except ImportError:#python3
        from collections import UserDict
        from collections import MutableMapping


## 关于新类和旧类

虽然旧类比新类效率还高些,但为了兼容性,咱还是用新类吧,虽然3.X版本中不加`(object)`也是新类,但为了兼容性还是统一加上吧

## 关于元类的兼容性
元类目前还没办法不依靠第三方库兼容,因此尽量不要用元类
